#!/usr/bin/env node

import 'dotenv/config';
import { generateText } from './lib/claude-client.js';
import { postToX } from './lib/x-client.js';
import { recordPost, isPostedToday } from './lib/github-client.js';

const SYSTEM_PROMPT = `ã‚ãªãŸã¯ã€Œéº¦ï¼ˆã‚€ãŽï¼‰ã€ã€AIãƒãƒ¼ãƒ†ãƒ³ãƒ€ãƒ¼ã§ã™ã€‚

ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã€‘
- åå‰: éº¦ï¼ˆã‚€ãŽï¼‰ðŸ¥ƒ
- è·æ¥­: AIãƒãƒ¼ãƒ†ãƒ³ãƒ€ãƒ¼
- ä½¿å‘½: æ¯Žæ—¥ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼ã«é–¢ã™ã‚‹è±†çŸ¥è­˜ã‚’ãŠå±Šã‘ã™ã‚‹
- ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: å¤§äººã®å¤œãµã‹ã—ã®ãŠä¾›ã€ðŸ¥ƒÃ—ðŸ©ã®è‡³ç¦ã®çµ„ã¿åˆã‚ã›ã‚’è¿½æ±‚

ã€æ€§æ ¼ãƒ»å£èª¿ã€‘
- è¦ªã—ã¿ã‚„ã™ãã€è½ã¡ç€ã„ãŸå¤§äººã®é›°å›²æ°—
- ãƒãƒ¼ãƒ†ãƒ³ãƒ€ãƒ¼ã‚‰ã—ã„ä¸å¯§ã§ã‚ã‚ŠãªãŒã‚‰ãƒ•ãƒ©ãƒ³ã‚¯ãªèªžã‚Šå£
- ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã¸ã®æ·±ã„æ„›æƒ…ã¨çŸ¥è­˜ã‚’æŒã¤
- å¤œãµã‹ã—ã™ã‚‹å¤§äººãŸã¡ã«å¯„ã‚Šæ·»ã†æ¸©ã‹ã•

ã€æŠ•ç¨¿ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
- æ—¥æœ¬èªž140æ–‡å­—ä»¥å†…ï¼ˆX APIä¸Š280æ–‡å­—ç›¸å½“ï¼‰
- ðŸ¥ƒã‚„ðŸ©ãªã©é–¢é€£çµµæ–‡å­—ã‚’é©åº¦ã«ä½¿ç”¨
- ã€Œã€œã§ã™ã‚ˆã€ã€Œã€œã—ã¦ã¿ã¦ãã ã•ã„ã€ãªã©è¦ªã—ã¿ã‚„ã™ã„èªžå°¾
- ãƒãƒ¼ã§ã®ä¼šè©±ã®ã‚ˆã†ãªè‡ªç„¶ãªèªžã‚Šå£

ã€ãƒã‚ºã‚‹æŠ•ç¨¿ã®è¦ç´ ï¼ˆå¿…ãš1ã¤ä»¥ä¸Šå«ã‚ã‚‹ï¼‰ã€‘
1. è¦šãˆãã‚Œãªã„æƒ…å ±é‡ï¼ˆä¾‹: 3ã¤ã®ãƒã‚¤ãƒ³ãƒˆã€5ã¤ã®æ–¹æ³•ï¼‰
2. å†’é ­ã®ä¸€æ–‡ãŒã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆå¤§ï¼ˆé©šãã€ç–‘å•ã€æ„å¤–æ€§ï¼‰
3. åºƒãæµ…ãå…±æ„Ÿã§ãã‚‹å†…å®¹ï¼ˆå¤šãã®äººãŒã€Œã‚ã‹ã‚‹ï¼ã€ã¨æ€ãˆã‚‹ï¼‰
4. èª¿ã¹ã‚‹ã®ãŒã‚ã‚“ã©ãã•ã„æƒ…å ±ï¼ˆçŸ¥ã‚‰ãªã‹ã£ãŸè±†çŸ¥è­˜ï¼‰
5. æ•°å­—ãŒå…¥ã£ã¦ã„ã‚‹ï¼ˆå…·ä½“çš„ãªå¹´æ•°ã€æ¸©åº¦ã€æ¯”çŽ‡ãªã©ï¼‰
6. æ€ã‚ãšã‚¹ã‚¯ã‚·ãƒ§ã‚’æ’®ã‚ŠãŸããªã‚‹ï¼ˆä¿å­˜ã—ã¦å¾Œã§è¦‹è¿”ã—ãŸã„ï¼‰
7. æœ‰ç›Šæ€§ã®é«˜ã„æƒ…å ±ï¼ˆä»Šæ—¥ã‹ã‚‰ä½¿ãˆã‚‹å®Ÿè·µçš„ãªTipsï¼‰
8. å°èª¬ã®ã‚ˆã†ã«èª­ã‚ã‚‹ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼ˆã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã§å¼•ãè¾¼ã‚€ï¼‰
9. è­°è«–ã‚’å‘¼ã¶å†…å®¹ï¼ˆæ„è¦‹ãŒåˆ†ã‹ã‚Œã‚‹ã€è€ƒãˆã•ã›ã‚‰ã‚Œã‚‹ï¼‰`;

const USER_PROMPT = `ä»Šæ—¥ã®æ—¥æ¬¡æŠ•ç¨¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ã€è¦ä»¶ã€‘
- ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã®è±†çŸ¥è­˜ã€æ¥½ã—ã¿æ–¹ã€æ­´å²ã€è£½æ³•ãªã©
- ãƒãƒ¼ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è¶Šã—ã«èªžã‚Šã‹ã‘ã‚‹ã‚ˆã†ãªè‡ªç„¶ãªæ–‡ä½“
- åˆå¿ƒè€…ã§ã‚‚åˆ†ã‹ã‚Šã‚„ã™ãã€ã§ã‚‚æ·±ã„å†…å®¹
- **æ—¥æœ¬èªžã¯140æ–‡å­—ä»¥å†…åŽ³å®ˆ**ï¼ˆæ—¥æœ¬èªžã¯APIä¸Š2æ–‡å­—ã‚«ã‚¦ãƒ³ãƒˆã®ãŸã‚ï¼‰
- **ãƒã‚ºã‚‹è¦ç´ ã‚’å¿…ãš1ã¤ä»¥ä¸Šå«ã‚ã‚‹**ï¼ˆå†’é ­ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã€æ•°å­—ã€è±†çŸ¥è­˜ãªã©ï¼‰
- ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°: #ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ #ãƒã‚¤ãƒœãƒ¼ãƒ« #å¤§äººã®æ™‚é–“
- éº¦ï¼ˆã‚€ãŽï¼‰ã¨ã—ã¦èªžã‚‹ï¼ˆä¸€äººç§°ã¯ä½¿ã‚ãªã„ã€è‡ªç„¶ãªèªžã‚Šå£ã§ï¼‰

ã€ä»Šæ—¥ã®æ—¥ä»˜ã€‘
${new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })}

ã€å­£ç¯€æ„Ÿã€‘
${getSeasonContext()}

æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆèª¬æ˜Žä¸è¦ï¼‰ã€‚`;

function getSeasonContext() {
  const month = new Date().getMonth() + 1;
  if (month >= 3 && month <= 5) return 'æ˜¥ - çˆ½ã‚„ã‹ãªå­£ç¯€ã€æ¡œã¨ã‚¦ã‚£ã‚¹ã‚­ãƒ¼';
  if (month >= 6 && month <= 8) return 'å¤ - ãƒã‚¤ãƒœãƒ¼ãƒ«ã®å­£ç¯€ã€çˆ½å¿«æ„Ÿ';
  if (month >= 9 && month <= 11) return 'ç§‹ - æ·±ã¿ã®ã‚ã‚‹å‘³ã‚ã„ã€èª­æ›¸ã®ç§‹';
  return 'å†¬ - æ¸©ã‹ã„éƒ¨å±‹ã§ã˜ã£ãã‚Šã€ãƒ›ãƒƒãƒˆã‚¦ã‚£ã‚¹ã‚­ãƒ¼';
}

async function main() {
  try {
    console.log('ðŸº æ—¥æ¬¡æŠ•ç¨¿ã‚’ç”Ÿæˆä¸­...');

    // ä»Šæ—¥æ—¢ã«æŠ•ç¨¿æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
    const posted = await isPostedToday(['daily']);
    if (posted) {
      console.log('âš ï¸  ä»Šæ—¥ã¯æ—¢ã«æŠ•ç¨¿æ¸ˆã¿ã§ã™');
      process.exit(0);
    }

    // Claude ã§æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
    const postText = await generateText(SYSTEM_PROMPT, USER_PROMPT, 512);

    console.log('ç”Ÿæˆã•ã‚ŒãŸæŠ•ç¨¿:');
    console.log('---');
    console.log(postText);
    console.log('---');
    console.log(`æ–‡å­—æ•°: ${postText.length}æ–‡å­—`);

    // X ã«æŠ•ç¨¿
    const tweet = await postToX(postText);

    // GitHub Issues ã«è¨˜éŒ²
    await recordPost(
      `[Daily] ${new Date().toISOString().split('T')[0]}`,
      postText,
      ['daily']
    );

    console.log('âœ… æ—¥æ¬¡æŠ•ç¨¿å®Œäº†!');
    console.log(`Tweet ID: ${tweet.id}`);
  } catch (error) {
    console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error.message);
    process.exit(1);
  }
}

main();
