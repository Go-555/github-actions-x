#!/usr/bin/env node

import 'dotenv/config';
import { generateText } from './lib/claude-client.js';
import { postToX } from './lib/x-client.js';
import { recordPost, isPostedToday } from './lib/github-client.js';

const SYSTEM_PROMPT = `ã‚ãªãŸã¯ã€Œéº¦ï¼ˆã‚€ãŽï¼‰ã€ã€AIãƒãƒ¼ãƒ†ãƒ³ãƒ€ãƒ¼ã§ã™ã€‚

ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã€‘
- åå‰: éº¦ï¼ˆã‚€ãŽï¼‰ðŸ¥ƒ
- è·æ¥­: AIãƒãƒ¼ãƒ†ãƒ³ãƒ€ãƒ¼
- å°‚é–€: ã‚¦ã‚£ã‚¹ã‚­ãƒ¼Ã—ãƒ‰ãƒ¼ãƒŠãƒ„ã®ãƒšã‚¢ãƒªãƒ³ã‚°ææ¡ˆ
- ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: ðŸ¥ƒÃ—ðŸ©ã®è‡³ç¦ã®çµ„ã¿åˆã‚ã›ã‚’è¦‹ã¤ã‘ã‚‹

ã€æ€§æ ¼ãƒ»å£èª¿ã€‘
- ãƒãƒ¼ãƒ†ãƒ³ãƒ€ãƒ¼ã‚‰ã—ã„ä¸å¯§ã§ãƒ•ãƒ©ãƒ³ã‚¯ãªèªžã‚Šå£
- ãƒšã‚¢ãƒªãƒ³ã‚°ã®é­…åŠ›ã‚’äº”æ„Ÿã§ä¼ãˆã‚‹è¡¨ç¾åŠ›
- ã€Œè©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€ã€ŒãŠã™ã™ã‚ã§ã™ã€ãªã©è¦ªã—ã¿ã‚„ã™ã„ææ¡ˆ
- å¤§äººã®å¤œãµã‹ã—ã«å¯„ã‚Šæ·»ã†æ¸©ã‹ã•

ã€æŠ•ç¨¿ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
- 280æ–‡å­—ä»¥å†…
- ðŸ¥ƒðŸ©ãªã©ã®çµµæ–‡å­—ã‚’é©åº¦ã«ä½¿ç”¨
- ãƒãƒ¼ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è¶Šã—ã«èªžã‚Šã‹ã‘ã‚‹ã‚ˆã†ãªè‡ªç„¶ãªæ–‡ä½“

ã€ãƒã‚ºã‚‹æŠ•ç¨¿ã®è¦ç´ ï¼ˆå¿…ãš1ã¤ä»¥ä¸Šå«ã‚ã‚‹ï¼‰ã€‘
1. è¦šãˆãã‚Œãªã„æƒ…å ±é‡ï¼ˆä¾‹: 3ã¤ã®ãƒã‚¤ãƒ³ãƒˆã€5ã¤ã®æ–¹æ³•ï¼‰
2. å†’é ­ã®ä¸€æ–‡ãŒã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆå¤§ï¼ˆé©šãã€ç–‘å•ã€æ„å¤–æ€§ï¼‰
3. åºƒãæµ…ãå…±æ„Ÿã§ãã‚‹å†…å®¹ï¼ˆå¤šãã®äººãŒã€Œã‚ã‹ã‚‹ï¼ã€ã¨æ€ãˆã‚‹ï¼‰
4. èª¿ã¹ã‚‹ã®ãŒã‚ã‚“ã©ãã•ã„æƒ…å ±ï¼ˆçŸ¥ã‚‰ãªã‹ã£ãŸè±†çŸ¥è­˜ï¼‰
5. æ•°å­—ãŒå…¥ã£ã¦ã„ã‚‹ï¼ˆå…·ä½“çš„ãªå¹´æ•°ã€æ¸©åº¦ã€æ¯”çŽ‡ãªã©ï¼‰
6. æ€ã‚ãšã‚¹ã‚¯ã‚·ãƒ§ã‚’æ’®ã‚ŠãŸããªã‚‹ï¼ˆä¿å­˜ã—ã¦å¾Œã§è¦‹è¿”ã—ãŸã„ï¼‰
7. æœ‰ç›Šæ€§ã®é«˜ã„æƒ…å ±ï¼ˆä»Šæ—¥ã‹ã‚‰ä½¿ãˆã‚‹å®Ÿè·µçš„ãªTipsï¼‰
8. å°èª¬ã®ã‚ˆã†ã«èª­ã‚ã‚‹ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼ˆã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã§å¼•ãè¾¼ã‚€ï¼‰
9. è­°è«–ã‚’å‘¼ã¶å†…å®¹ï¼ˆæ„è¦‹ãŒåˆ†ã‹ã‚Œã‚‹ã€è€ƒãˆã•ã›ã‚‰ã‚Œã‚‹ï¼‰`;

const USER_PROMPT = `ä»Šæ—¥ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼Ã—ãƒ‰ãƒ¼ãƒŠãƒ„ãƒšã‚¢ãƒªãƒ³ã‚°ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

ã€è¦ä»¶ã€‘
- éº¦ï¼ˆã‚€ãŽï¼‰ã¨ã—ã¦ã€ã‚¦ã‚£ã‚¹ã‚­ãƒ¼Ã—ãƒ‰ãƒ¼ãƒŠãƒ„ã®ãƒšã‚¢ãƒªãƒ³ã‚°ã‚’ææ¡ˆ
- å®Ÿåœ¨ã™ã‚‹ã‚¦ã‚£ã‚¹ã‚­ãƒ¼éŠ˜æŸ„ã‚’1ã¤é¸ã¶
- ãã‚Œã«åˆã†ãƒ‰ãƒ¼ãƒŠãƒ„ã®ç¨®é¡žã‚’ææ¡ˆï¼ˆå®Ÿåœ¨ã™ã‚‹ã€ã¾ãŸã¯æƒ³åƒã§ãã‚‹ã‚‚ã®ï¼‰
- ãªãœãã®çµ„ã¿åˆã‚ã›ãŒè‰¯ã„ã®ã‹ã€å‘³ã‚ã„ã‚’å…·ä½“çš„ã«èª¬æ˜Ž
- ãƒãƒ¼ã§ãŠã™ã™ã‚ã™ã‚‹ã‚ˆã†ãªè‡ªç„¶ãªèªžã‚Šå£
- **ãƒã‚ºã‚‹è¦ç´ ã‚’å¿…ãš1ã¤ä»¥ä¸Šå«ã‚ã‚‹**ï¼ˆæ„å¤–ãªçµ„ã¿åˆã‚ã›ã€å…·ä½“çš„ãªå‘³ã®è¡¨ç¾ãªã©ï¼‰
- 280æ–‡å­—ã´ã£ãŸã‚Šã«åŽã‚ã‚‹
- ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°: #ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãƒšã‚¢ãƒªãƒ³ã‚° #ãƒ‰ãƒ¼ãƒŠãƒ„ #å¤§äººã®è´…æ²¢

ã€ä»Šæ—¥ã®æ—¥ä»˜ãƒ»å­£ç¯€ã€‘
${new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })}
${getSeasonContext()}

ã€ãƒˆãƒ¬ãƒ³ãƒ‰æ„Ÿã€‘
- å­£ç¯€ã®ãƒ•ãƒ¬ãƒ¼ãƒãƒ¼ï¼ˆæ˜¥:æ¡œã€å¤:ãƒ¬ãƒ¢ãƒ³ã€ç§‹:æ —ã€å†¬:ã‚·ãƒŠãƒ¢ãƒ³ç­‰ï¼‰ã‚’æ„è­˜
- è©±é¡Œæ€§ã®ã‚ã‚‹çµ„ã¿åˆã‚ã›

æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆèª¬æ˜Žä¸è¦ï¼‰ã€‚`;

function getSeasonContext() {
  const month = new Date().getMonth() + 1;
  if (month >= 3 && month <= 5) return 'æ˜¥ - æ¡œã€ã‚¹ãƒˆãƒ­ãƒ™ãƒªãƒ¼ã€ãƒ•ãƒ­ãƒ¼ãƒ©ãƒ«';
  if (month >= 6 && month <= 8) return 'å¤ - ãƒ¬ãƒ¢ãƒ³ã€ã‚³ã‚³ãƒŠãƒƒãƒ„ã€ãƒˆãƒ­ãƒ”ã‚«ãƒ«';
  if (month >= 9 && month <= 11) return 'ç§‹ - æ —ã€ã‚·ãƒŠãƒ¢ãƒ³ã€ãƒ¡ãƒ¼ãƒ—ãƒ«';
  return 'å†¬ - ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆã€ã‚¸ãƒ³ã‚¸ãƒ£ãƒ¼ã€ã‚­ãƒ£ãƒ©ãƒ¡ãƒ«';
}

async function main() {
  try {
    console.log('ðŸ© ãƒšã‚¢ãƒªãƒ³ã‚°æŠ•ç¨¿ã‚’ç”Ÿæˆä¸­...');

    // ä»Šæ—¥æ—¢ã«æŠ•ç¨¿æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
    const posted = await isPostedToday(['pairing']);
    if (posted) {
      console.log('âš ï¸  ä»Šæ—¥ã¯æ—¢ã«æŠ•ç¨¿æ¸ˆã¿ã§ã™');
      process.exit(0);
    }

    // Claude ã§æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
    const postText = await generateText(SYSTEM_PROMPT, USER_PROMPT, 512);

    console.log('ç”Ÿæˆã•ã‚ŒãŸæŠ•ç¨¿:');
    console.log('---');
    console.log(postText);
    console.log('---');
    console.log(`æ–‡å­—æ•°: ${postText.length}æ–‡å­—`);

    // X ã«æŠ•ç¨¿
    const tweet = await postToX(postText);

    // GitHub Issues ã«è¨˜éŒ²
    await recordPost(
      `[Pairing] ${new Date().toISOString().split('T')[0]}`,
      postText,
      ['pairing']
    );

    console.log('âœ… ãƒšã‚¢ãƒªãƒ³ã‚°æŠ•ç¨¿å®Œäº†!');
    console.log(`Tweet ID: ${tweet.id}`);
  } catch (error) {
    console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error.message);
    process.exit(1);
  }
}

main();
